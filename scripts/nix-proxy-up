#!/usr/bin/env bash

# Script to enable sing-box tunnel by uncommenting the import
# and rebuilding NixOS

set -e

CONFIG_FILE="/home/esc2/repos/nixos/nixos/networking/default.nix"
BACKUP_FILE="/home/esc2/repos/nixos/nixos/networking/default.nix.backup"

# Create backup if it doesn't exist
if [ ! -f "$BACKUP_FILE" ]; then
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    echo "Created backup at $BACKUP_FILE"
fi

echo "Enabling sing-box tunnel configuration..."

# Uncomment the sing-box import line
sed -i 's/^  # Import sing-box configuration$/  # Import sing-box configuration/' "$CONFIG_FILE"
sed -i 's/^  # imports = \[ \.\/sing-box\.nix \];$/  imports = [ .\/sing-box.nix ];/' "$CONFIG_FILE"

echo "Configuration updated. Rebuilding NixOS..."

# Change to the nixos directory and rebuild
cd /home/esc2/repos/nixos
make tb14

echo "NixOS rebuild completed. Sing-box tunnel is now enabled."